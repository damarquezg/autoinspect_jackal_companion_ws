<?xml version="1.0" ?>
<launch>
  <!-- Launch localization based on ICP -->
  <!-- This relies on another odometry source to be present that publishes an odom frame -->

  <!-- The path to the map that ICP should localize against, e.g. ~/vilens_slam_data/online_slam_output/combined_cloud.ply -->
  <arg name="map"/>
  <!-- Use this file to extend or override the parameters in the base localisation file. -->
  <arg name="localisation_config_extension_file" default="$(find autoinspect_jackal_bringup)/config/localization/icp/localization_hesai.yaml"/>
  <!-- Name of the frame that is generated by static transform -->
  <arg name="static_transform_output_frame" default="map"/>
  <!-- Visualize ICP Odometry trajectory -->
  <arg name="run_trajectory_server" default="false"/>

  <node name="icp_odometry_ros" pkg="icp_odometry_ros" type="icp_odometry_node" output="screen">
    <rosparam file="$(find autoinspect_jackal_bringup)/config/localization/icp/localization.yaml" subst_value="true" />
    <rosparam if="$(eval len(localisation_config_extension_file) != 0)"
              file="$(arg localisation_config_extension_file)" subst_value="true"/>
    <param name="map_from_file_path" type="string" value="$(arg map)"/>
  </node>

  <group if="$(arg run_trajectory_server)">
    <node name="icp_odometry_trajectory_server" pkg="hector_trajectory_server" type="hector_trajectory_server" output="screen">
      <remap from="/trajectory"             to="/icp_odometry/trajectory"/>
      <param name="target_frame_name"       type="string" value="/odom_icp"/>
      <param name="source_frame_name"       type="string" value="/body_odom_icp"/>
      <param name="trajectory_update_rate"  type="double" value="10"/>
      <param name="trajectory_publish_rate" type="double" value="10"/>
    </node>
  </group>

  <!-- Identity transform between odom and map to allow visualisations to work in map frame  -->
  <node name="odom_icp_to_map" pkg="tf" type="static_transform_publisher" 
        args="0 0 0 0 0 0 1 odom_icp $(arg static_transform_output_frame) 10"/>

  <!-- Merge the two transform trees -->
  <include file="$(find autoinspect_jackal_bringup)/launch/localization/icp/tf_bridge_odom_odom_icp.launch"/>

</launch>
